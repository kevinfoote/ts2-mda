<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"    
       default-init-method="initialize"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
       xsi:schemaLocation="
           http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd 
           http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd">

    <bean id="ts_federation_uri" class="java.lang.String">
        <constructor-arg value="http://www.testshib.org/fed"/>
    </bean>

    <bean id="ts_providers_uri" class="java.lang.String">
        <constructor-arg value="http://www.testshib.org/providers"/>
    </bean>

    <bean id="ts_prod_aggregate" class="java.lang.String">
        <constructor-arg value="/var/www/html/metadata.new/testshib-aggregate.xml"/>
    </bean>
    
    <bean id="ts_prov_aggregate" class="java.lang.String">
        <constructor-arg value="/var/www/html/metadata.new/testshib-providers.xml"/>
    </bean>

    <bean id="source1" class="net.shibboleth.metadata.dom.DOMFilesystemSourceStage">
        <property name="id" value="source1"/>
        <property name="parserPool">
            <bean class="net.shibboleth.utilities.java.support.xml.BasicParserPool" init-method="initialize"/>
        </property>
        <property name="source">
            <bean class="java.io.File">
                <constructor-arg value="/opt/testshib-user-metadata/"/>
            </bean>
        </property>
    </bean>
   
    <bean id="source2" class="net.shibboleth.metadata.dom.DOMFilesystemSourceStage">
        <property name="id" value="source2"/>
        <property name="parserPool">
            <bean class="net.shibboleth.utilities.java.support.xml.BasicParserPool" init-method="initialize"/>
        </property>
        <property name="source">
            <bean class="java.io.File">
                <constructor-arg value="/opt/testshib-entities-metadata/"/>
            </bean>
        </property>
    </bean>

    <bean id="disassemble" class="net.shibboleth.metadata.dom.saml.EntitiesDescriptorDisassemblerStage">
        <property name="id" value="disassemble"/>
    </bean>

    <bean id="removeInvalidContactPerson" class="net.shibboleth.metadata.dom.saml.ContactPersonFilterStage">
        <property name="id" value="removeInvalidContactPerson"/>
    </bean>
    
    <bean id="removeOrganization" class="net.shibboleth.metadata.dom.saml.RemoveOrganizationStage">
        <property name="id" value="removeOrganization"/>
    </bean>
    
    <bean id="createEntitiesDescriptor" class="net.shibboleth.metadata.dom.saml.EntitiesDescriptorAssemblerStage">
        <property name="id" value="createEntitiesDescriptor"/>
        <property name="descriptorName" ref="ts_federation_uri"/>
    </bean>
    
    <bean id="generateContentReferenceId" class="net.shibboleth.metadata.dom.saml.GenerateIdStage">
        <property name="id" value="generateContentReferenceId" />
    </bean>
    
<!--
    <bean id="signMetadata" class="net.shibboleth.metadata.dom.XMLSignatureSigningStage">
        <property name="id" value="signMetadata"/>
        <property name="privateKey">
            <bean class="net.shibboleth.ext.spring.factory.PrivateKeyFactoryBean">
                <property name="privateKeyFile">
                    <bean class="java.io.File">
                        <constructor-arg value="path/to/private-key.pem"/>
                    </bean>
                </property>
            </bean>
        </property>
    </bean>
-->
    
    <bean id="serializeProd" class="net.shibboleth.metadata.pipeline.SerializationStage">
        <property name="id" value="serializeIdPs"/>
        <property name="outputFile">
            <bean class="java.io.File">
                <constructor-arg ref="ts_prod_aggregate"/>
            </bean>
        </property>
        <property name="serializer">
            <bean id="domSerializer" class="net.shibboleth.metadata.dom.DOMElementSerializer" />
        </property>
    </bean>    

    <bean id="serializeProviders" class="net.shibboleth.metadata.pipeline.SerializationStage">
        <property name="id" value="serializeIdPs"/>
        <property name="outputFile">
            <bean class="java.io.File">
                <constructor-arg ref="ts_prov_aggregate"/>
            </bean>
        </property>
        <property name="serializer">
            <bean id="domSerializer" class="net.shibboleth.metadata.dom.DOMElementSerializer" />
        </property>
    </bean>    
     
    <!--

    * Pipeline to create the current federation aggregate. 
    * Testshib keeps an entity active for 30 days

    -->
    <bean id="prod" class="net.shibboleth.metadata.pipeline.SimplePipeline" init-method="initialize">
        <property name="id" value="production_pipeline"/>
        <property name="stages">
            <list>
                <ref bean="source1"/>
                <ref bean="source2"/>
                <ref bean="disassemble"/>
                <ref bean="removeInvalidContactPerson"/>
                <ref bean="removeOrganization"/>
                <ref bean="createEntitiesDescriptor"/>
                <ref bean="generateContentReferenceId" />
                <ref bean="serializeProd" />
            </list>
        </property>
    </bean>

    <!--

    * Pipeline to create the current TestShib providers aggregate. 
    * Our providers are idp.testshib.org and sp.testshib.org

    -->
    <bean id="providers" class="net.shibboleth.metadata.pipeline.SimplePipeline" init-method="initialize">
        <property name="id" value="providers_pipeline"/>
        <property name="stages">
            <list>
                <ref bean="source2"/>
                <ref bean="removeInvalidContactPerson"/>
                <ref bean="removeOrganization"/>
                <ref bean="createEntitiesDescriptor"/>
                <ref bean="generateContentReferenceId" />
                <ref bean="serializeProviders" />
            </list>
        </property>
    </bean>
    
</beans>
